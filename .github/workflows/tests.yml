name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  pest:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.2'
            laravel: '^10.0'
          - php: '8.2'
            laravel: '^11.0'
          - php: '8.3'
            laravel: '^12.0'

    name: PHP ${{ matrix.php }} - Laravel ${{ matrix.laravel }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none
        extensions: mbstring, tokenizer, sqlite, pdo_sqlite
        tools: none

      - name: Install dependencies
        run: |
          composer update \
            --prefer-dist \
            --no-progress \
            --no-interaction \
            --with="illuminate/support:${{ matrix.laravel }}" \
            --with="illuminate/console:${{ matrix.laravel }}" \
            --with="illuminate/database:${{ matrix.laravel }}" \
            --with="illuminate/notifications:${{ matrix.laravel }}" \
            --with-all-dependencies

      - name: Run migrations (Testbench)
        run: vendor/bin/testbench migrate --database=testing --realpath=database/migrations

      - name: Execute smart scheduler wrapper
        run: vendor/bin/testbench smart-schedule:run

      - name: Assert scheduler run persisted
        run: |
          vendor/bin/testbench tinker --execute="exit(\Jiordiviera\SmartScheduler\LaravelSmartScheduler\Models\SmartSchedulerRun::count() > 0 ? 0 : 1);"

      - name: Run tests
        run: composer test
